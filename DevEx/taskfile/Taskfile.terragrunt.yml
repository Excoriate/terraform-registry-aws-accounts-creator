---
version: '3'

vars:
    TF_WORKING_DIR: '{{default "." .TF_WORKING_DIR}}'

tasks:
    check-workdir:
        desc: Validate whether the working directory passed is valid for terragrunt
        cmds:
            - |
              if [ -z "{{.TF_WORKING_DIR}}" ]; then
                echo "Working directory is not set (check variable TF_WORKING_DIR)"
                echo "If not set, it's fallback to the default working directory"
              elif [ ! -d {{.TF_WORKING_DIR}} ]; then
                echo "Working directory {{.TF_WORKING_DIR}} is not a valid directory in path $(pwd)"
                exit 1
              else
                if [ -z "$(find {{.TF_WORKING_DIR}} -name '*.hcl' -print -quit)" ]; then
                  echo "No valid .hcl files found in working directory"
                  exit 1
                elif [ -z "$(find {{.TF_WORKING_DIR}} -name 'terragrunt.hcl' -print -quit)" ]; then
                  echo "No terragrunt.hcl file found in working directory"
                  exit 1
                else
                  echo "Working directory is set, exists, and contains valid .hcl files, including a terragrunt.hcl file: {{.TF_WORKING_DIR}}"
                fi
              fi

    init:
        deps: [check-workdir]
        desc: Run Terragrunt init
        cmds:
            - |
              echo "Working directory: {{.TF_WORKING_DIR}}"
              echo "Full path: $(pwd)/{{.TF_WORKING_DIR}}"

              if [ -z "{{.TF_WORKING_DIR}}" ] || [ "{{.TF_WORKING_DIR}}" = "." ]; then
                  echo "Working directory is not set (check variable TF_WORKING_DIR)"
                  echo "If not set, it's fallback to the default working directory"
              else
                  echo "Working directory is set: {{.TF_WORKING_DIR}}"
              fi

              cd {{.TF_WORKING_DIR}}

              terragrunt init

    plan:
        desc: Run Terragrunt plan
        deps: [init]
        cmds:
            - |
              echo "Running Terragrunt plan in {{.TF_WORKING_DIR}}"
              echo "Full path is $(pwd)/{{.TF_WORKING_DIR}}"

              if [ -z "{{.TF_WORKING_DIR}}" ] || [ "{{.TF_WORKING_DIR}}" = "." ]; then
                  echo "Working directory is not set (check variable TF_WORKING_DIR)"
                  echo "If not set, it's fallback to the default working directory"
              else
                  echo "Working directory is set: {{.TF_WORKING_DIR}}"
              fi

              cd {{.TF_WORKING_DIR}}

              terragrunt plan

    apply:
        desc: Run Terragrunt apply
        deps: [init]
        cmds:
            - |
              echo "Running Terragrunt Apply in {{.TF_WORKING_DIR}}"
              echo "Full path is $(pwd)/{{.TF_WORKING_DIR}}"

              if [ -z "{{.TF_WORKING_DIR}}" ] || [ "{{.TF_WORKING_DIR}}" = "." ]; then
                  echo "Working directory is not set (check variable TF_WORKING_DIR)"
                  echo "If not set, it's fallback to the default working directory"
              else
                  echo "Working directory is set: {{.TF_WORKING_DIR}}"
              fi

              cd {{.TF_WORKING_DIR}}

              terragrunt apply -auto-approve

    destroy:
        desc: Run Terragrunt destroy
        deps: [init]
        cmds:
            - |
              echo "Running Terragrunt Destroy in {{.TF_WORKING_DIR}}"
              echo "Full path is $(pwd)/{{.TF_WORKING_DIR}}"

              if [ -z "{{.TF_WORKING_DIR}}" ] || [ "{{.TF_WORKING_DIR}}" = "." ]; then
                  echo "Working directory is not set (check variable TF_WORKING_DIR)"
                  echo "If not set, it's fallback to the default working directory"
              else
                  echo "Working directory is set: {{.TF_WORKING_DIR}}"
              fi

              cd {{.TF_WORKING_DIR}}

              terragrunt destroy

    lint:
        desc: Run Terragrunt Linters and Validators
        deps: [check-workdir]
        cmds:
            - |
              echo "Running Terragrunt fmt check in {{.TF_WORKING_DIR}}"
              echo "Full path is $(pwd)/{{.TF_WORKING_DIR}}"

              if [ -z "{{.TF_WORKING_DIR}}" ] || [ "{{.TF_WORKING_DIR}}" = "." ]; then
                  echo "Working directory is not set (check variable TF_WORKING_DIR)"
                  echo "If not set, it's fallback to the default working directory"
              else
                  echo "Working directory is set: {{.TF_WORKING_DIR}}"
              fi

              cd {{.TF_WORKING_DIR}}

              terragrunt fmt -check
              terragrunt hclfmt
              terragrunt validate-inputs --terragrunt-strict-validate
